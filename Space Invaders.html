<!doctype html>

<head>
    <title>Canvas</title>
    <script src="player.js"></script>
    <script src="invader.js"></script>
    <!--    <script src="invaderBullet.js"></script>-->
    <script src="playerBullet.js"></script>
    <!--adds external .js files-->
</head>

<body>
    <canvas id="gameCanvas" width="500" height="500"></canvas>
 <!-- sets canvas size-->
    <script>
        var canvas, canvasContext;

        window.onload = function() {
            canvas = document.getElementById('gameCanvas');
            canvasContext = canvas.getContext('2d');

            document.addEventListener('keydown', keyPressed);
            document.addEventListener('keyup', keyReleased);

            setInterval(mainloop, 1000 / 50);  //runs code at 50 times per second
        }
        //vars

        //player vars
        var pXpos = 0;
        var pYpos = 0;
        const P_WIDTH = 30;
        const P_HEIGHT = 30;
        var pXspeed = 5;
        //key vars
        const LEFT_KEY = 37;
        const RIGHT_KEY = 39;
        const SPACE_KEY = 32;
        var leftKeyPressed = false;
        var rightKeyPressed = false;
        var spaceKeyPressed = false;

        var startingPos = true;
        var endgame = true;
        //enemies vars
        var enemies = [];
        var eCount = 0;
        var eRowCount = 0;
        var eXpos = 10;
        var Ymod = 0;
        var eYpos = 10;
        var eSize = 15;
        var eSpeed = 2;
        var totalEnemies = 75;

        //bullet vars
        var bullets = [];
        var pBulletXpos = 0;
        var pBulletYpos = 435;
        var bCool = true;
        //        var eBullet = [];
        //        var eBulletXpos = 0;
        //        var eBulletYpos = 0;
        var bulletSpeed = 8;
        var bulletWidth = 5;
        var bulletHeight = 15;


        var player = new
        Player(pXpos, pYpos, P_WIDTH, P_HEIGHT, '#19E800', pXspeed);
        var enemyReady = false;

        function mainloop() {
            if (endgame) {

                colorRect(0, 0, canvas.width, canvas.height, 'black');  //color rect for canvas

                player.move();
                player.draw();
                makepBullet();

                if (bullets.length > 0) {
                    bullets.forEach(function(playerB, i) {
                        playerB.draw();
                        playerB.move();
//                        playerB.hasHitItem();
//                        playerB.outOfBounds();
                        if(playerB.outOfBounds() || playerB.hasCollided()){
                            delete bullets[i];
                        }
                    });
                    bullets = bullets.filter(item => item !== undefined);

                }


                if (startingPos) {
                    player.startPos();
                    makeEnemy(); //starts player in middle of screen
                }

                if (enemies.length > 0) {
                    enemies.forEach(function(enemy, i) {
                        enemy.draw();  //draws enemies
                    });

                    enemyReady = true;
                }

                if (enemies.length > 0 && enemyReady) {
                    enemies.forEach(function(enemy, i) {
                        enemy.touchPlayer();
                        enemy.move();  //makes enemies move and end game if they touch player

                    });

                    enemies.forEach(function(enemy, i) {
                        if (enemy.edgeHit()) {
                            for (i = 0; i < enemies.length; i++) {
                                enemies[i].drop();
                            }
                        }
                    });
                } //enemies bracket

            } //if endgame bracket
    
        } //mainloop bracket

        function keyPressed(evt) {     //detects if keys have been pressed 
            if (evt.keyCode == LEFT_KEY) {
                leftKeyPressed = true;
            }
            if (evt.keyCode == RIGHT_KEY) {
                rightKeyPressed = true;
            }
            if (evt.keyCode == SPACE_KEY) {
                spaceKeyPressed = true;
            }
        }

        function keyReleased(evt) {     //detects if keys have beeen released
            if (evt.keyCode == LEFT_KEY) {
                leftKeyPressed = false;
            }
            if (evt.keyCode == RIGHT_KEY) {
                rightKeyPressed = false;
            }
            if (evt.keyCode == SPACE_KEY) {
                spaceKeyPressed = false;
            }
        }

        function makeEnemy() {  //makes enemies and places them 
            for (var i = 0; i < totalEnemies; i++) {

                var eXpos = 15 + (25 * i);
                var eYpos = 10;

                if (i > 14) {
                    var eYpos = 35 + Ymod;
                    var eXpos = 15 + (25 * eRowCount);
                    eRowCount = eRowCount + 1;
                }
                if (i == 29) {
                    eRowCount = 0;
                    Ymod = 25;
                }
                if (i == 44) {
                    eRowCount = 0;
                    Ymod = 50;
                }
                if (i == 59) {
                    eRowCount = 0;
                    Ymod = 75;
                }


                var e = new Enemy(eXpos, eYpos, eSize, eSize, 'white', eSpeed, eSpeed); //draws enemies

                enemies.push(e);
            }
        }

        function makepBullet() {   //makes the players bullet
            if (spaceKeyPressed == true && bCool == true) {
                console.log("bullet");
                var pBulletXpos = player.x + P_WIDTH/2;

                var p = new playerB(pBulletXpos, pBulletYpos, bulletWidth, bulletHeight, 'red', bulletSpeed);

                bullets.push(p);
                bCool = false;
                setTimeout(cooldown, 1000); // adds cooldown to prevent laser beam of death
            }

        }

        function cooldown() {
            bCool = true    
        }


        function colorRect(x, y, w, h, c) { //main color rect
            canvasContext.fillStyle = c;
            canvasContext.fillRect(x, y, w, h);
        }

    </script>
</body>
